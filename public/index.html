<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create and Share HTML Games</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2em;
            cursor: pointer;
        }

        .auth-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 300px;
            font-family: 'Courier New', monospace;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .game-tile {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .game-tile:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .game-tile .game-title {
             cursor: pointer;
        }

        .game-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .game-author {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .game-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #f3f4f6;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
            font-size: 0.9em;
        }

        .stat.active {
            color: #667eea;
            font-weight: bold;
        }

        .game-detail-modal .modal-content {
            max-width: 800px;
            max-height: 90vh;
        }

        .game-iframe {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 10px;
            margin: 20px 0;
        }

        .interaction-bar {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: #f9fafb;
            border-radius: 10px;
        }

        .interaction-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .interaction-btn:hover {
            background: #f3f4f6;
        }

        .interaction-btn.active {
            border-color: #667eea;
            background: #eff6ff;
            color: #667eea;
        }

        .comments-section {
            margin-top: 20px;
        }

        .comment {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .comment-author {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .comment-text {
            color: #333;
        }

        .user-info {
            color: #667eea;
            font-weight: 600;
        }

        .close-btn {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .error {
            color: #ef4444;
            margin-top: 10px;
            font-size: 14px;
        }

        .success {
            color: #10b981;
            margin-top: 10px;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: white;
        }

        .empty-state h2 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 1.2em;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 onclick="showHomePage()">🎮 Home</h1>
            Create and Share HTML Games
            <div class="auth-section" id="authSection">
                <button class="btn btn-primary" onclick="showLogin()">Login</button>
                <button class="btn btn-secondary" onclick="showRegister()">Register</button>
            </div>
            <div class="auth-section" id="userSection" style="display: none;">
                <span class="user-info" id="username"></span>
                <button class="btn btn-primary" onclick="showCreateGame()">Create Game</button>
                <button class="btn btn-secondary" onclick="showProfilePage()">Profile</button>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="games-grid" id="gamesGrid"></div>
        <div id="profilePage" style="display: none;">
            <h2 id="profileTitle" style="color: white; margin-bottom: 20px;"></h2>
            <div id="profileDetails" style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; display: none;">
                <h3 style="margin-bottom: 15px;">My Profile</h3>
                <p><strong>Full Name:</strong> <span id="profileFullName"></span></p>
                <p><strong>School:</strong> <span id="profileSchoolName"></span></p>
                <p><strong>Class:</strong> <span id="profileClass"></span></p>
                <p><strong>Email:</strong> <span id="profileEmail"></span></p>
                <p><strong>Phone:</strong> <span id="profilePhoneNumber"></span></p>
                <button class="btn btn-secondary" style="margin-top: 15px;" onclick="showEditProfile()">Edit Profile</button>
            </div>
            <div class="games-grid" id="profileGamesGrid"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('loginModal')">&times;</span>
            <h2>Login</h2>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="loginUsername" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password">
            </div>
            <button class="btn btn-primary" onclick="login()">Login</button>
            <div id="loginError" class="error"></div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('registerModal')">&times;</span>
            <h2>Register</h2>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="registerUsername" placeholder="Choose username">
            </div>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="registerFullName" placeholder="Enter your full name">
            </div>
            <div class="form-group">
                <label>School Name</label>
                <input type="text" id="registerSchoolName" placeholder="Enter your school name">
            </div>
            <div class="form-group">
                <label>Class</label>
                <input type="text" id="registerClass" placeholder="Enter your class">
            </div>
            <div class="form-group">
                <label>Email Address (Optional)</label>
                <input type="email" id="registerEmail" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label>Phone Number (Optional)</label>
                <input type="tel" id="registerPhoneNumber" placeholder="Enter your phone number">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="registerPassword" placeholder="Choose password">
            </div>
            <button class="btn btn-primary" onclick="register()">Register</button>
            <div id="registerError" class="error"></div>
        </div>
    </div>

    <!-- Create Game Modal -->
    <!-- <div class="modal" id="createGameModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('createGameModal')">&times;</span>
            <h2>Create New Game</h2>
            <div class="form-group">
                <label>Game Title</label>
                <input type="text" id="gameTitle" placeholder="Enter game title">
            </div>
            <div class="form-group">
                <label>HTML Content</label>
                <textarea id="gameHtml" placeholder="Paste your HTML game code here..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="createGame()">Create Game</button>
            <div id="createError" class="error"></div>
        </div>
    </div> -->

    <div class="modal" id="createGameModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('createGameModal')">&times;</span>
            <h2>Create New Game</h2>

            <p class="info-text">
                💡 New to making games with AI? No worries! 
                Follow this simple <a href="https://docs.google.com/document/d/1YZfG45JBqzss6SE8rVEbJQXJFtPMUB0P7ahC1GcsltU/edit?usp=sharing" target="_blank">tutorial guide</a> to learn how to create your first game.
            </p>

            <div class="instructions">
                <h3>How to Create a Game:</h3>
                <ol>
                    <li>Go to any AI chat platform — ChatGPT, Gemini, Claude, or others.</li>
                    <li>Type a prompt like: <br><code>"Create a car racing game in a single standalone HTML file"</code> You can find prompts in comment section of a game.</li>
                    <li>Copy the HTML code generated by the AI.</li>
                    <li>Enter a game title below, paste the code, and click <strong>Create Game</strong>.</li>
                </ol>
            </div>

            <div class="form-group">
                <label>Game Title</label>
                <input type="text" id="gameTitle" placeholder="Enter game title">
            </div>

            <div class="form-group">
                <label>HTML Content</label>
                <textarea id="gameHtml" placeholder="Paste your HTML game code here..."></textarea>
            </div>

            <button class="btn btn-primary" onclick="createGame()">Create Game</button>
            <div id="createError" class="error"></div>
        </div>
    </div>
    <style>
    .info-text {
        background: #eef7ff;
        padding: 10px 12px;
        border-left: 4px solid #007bff;
        border-radius: 6px;
        font-size: 14px;
        margin-bottom: 12px;
    }
    .info-text a {
        color: #007bff;
        text-decoration: underline;
    }
    .instructions {
        background: #f8f9fa;
        padding: 10px 12px;
        border-radius: 6px;
        font-size: 14px;
        margin-bottom: 15px;
    }
    .instructions h3 {
        font-size: 15px;
        margin-bottom: 6px;
        color: #333;
    }
    .instructions ol {
        padding-left: 20px;
        margin: 0;
    }
    .instructions code {
        background: #f1f1f1;
        padding: 3px 6px;
        border-radius: 4px;
        font-size: 13px;
    }
</style>
    <!-- Game Detail Modal -->
    <div class="modal game-detail-modal" id="gameDetailModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('gameDetailModal')">&times;</span>
            <h2 id="gameDetailTitle"></h2>
            <p class="game-author" id="gameDetailAuthor"></p>
            <p class="game-author-info" id="gameDetailAuthorInfo" style="color: #666; font-size: 0.9em; margin-bottom: 15px;"></p>
            
            <div id="gamePlaySection" style="text-align: center; margin: 30px 0;">
                <button class="btn btn-primary" style="padding: 15px 40px; font-size: 18px;" onclick="playGame()">▶️ Play Game</button>
            </div>

            <div class="interaction-bar">
                <button class="interaction-btn" id="likeBtn" onclick="likeGame()">
                    👍 <span id="likeCount">0</span>
                </button>
                <button class="interaction-btn" id="dislikeBtn" onclick="dislikeGame()">
                    👎 <span id="dislikeCount">0</span>
                </button>
                <button class="interaction-btn">
                    💬 <span id="commentCountDetail">0</span>
                </button>
            </div>

            <div class="comments-section">
                <h3>Comments</h3>
                <div class="form-group" style="margin: 15px 0;">
                    <textarea id="commentText" placeholder="Write a comment..." style="min-height: 80px;"></textarea>
                    <button class="btn btn-primary" style="margin-top: 10px;" onclick="addComment()">Post Comment</button>
                </div>
                <div id="commentsList"></div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('editProfileModal')">&times;</span>
            <h2>Edit Profile</h2>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="editFullName" placeholder="Enter your full name">
            </div>
            <div class="form-group">
                <label>School Name</label>
                <input type="text" id="editSchoolName" placeholder="Enter your school name">
            </div>
            <div class="form-group">
                <label>Class</label>
                <input type="text" id="editClass" placeholder="Enter your class">
            </div>
            <div class="form-group">
                <label>Email Address (Optional)</label>
                <input type="email" id="editEmail" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label>Phone Number (Optional)</label>
                <input type="tel" id="editPhoneNumber" placeholder="Enter your phone number">
            </div>
            <button class="btn btn-primary" onclick="updateProfile()">Save Changes</button>
            <div id="editProfileError" class="error"></div>
        </div>
    </div>

    <!-- Update Game Modal -->
    <div class="modal" id="updateGameModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('updateGameModal')">&times;</span>
            <h2>Update Game</h2>
            <input type="hidden" id="updateGameId">
            <div class="form-group">
                <label>Game Title</label>
                <input type="text" id="updateGameTitle" placeholder="Enter game title">
            </div>
            <div class="form-group">
                <label>HTML Content</label>
                <textarea id="updateGameHtml" placeholder="Paste your HTML game code here..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="updateGame()">Save Changes</button>
            <div id="updateError" class="error"></div>
        </div>
    </div>

    <script>
        let currentGameId = null;
        let isAuthenticated = false;
        let isAdmin = false;

        // Check session on load
        async function checkSession() {
            try {
                const res = await fetch('/api/check-session');
                const data = await res.json();
                if (data.authenticated) {
                    isAuthenticated = true;
                    isAdmin = data.isAdmin;
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('userSection').style.display = 'flex';
                    document.getElementById('username').textContent = data.username;
                }
            } catch (err) {
                console.error('Session check failed:', err);
            }
            loadGames();
        }

        function showLogin() {
            document.getElementById('loginModal').classList.add('active');
        }

        function showRegister() {
            document.getElementById('registerModal').classList.add('active');
        }

        function showCreateGame() {
            if (!isAuthenticated) {
                alert('Please login first');
                return;
            }
            document.getElementById('createGameModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            // Clear error messages
            const errorElements = document.querySelectorAll('.error');
            errorElements.forEach(el => el.textContent = '');
        }

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                document.getElementById('loginError').textContent = 'Please fill all fields';
                return;
            }
            
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    isAuthenticated = true;
                    isAdmin = data.isAdmin;
                    closeModal('loginModal');
                    checkSession();
                    document.getElementById('loginUsername').value = '';
                    document.getElementById('loginPassword').value = '';
                } else {
                    document.getElementById('loginError').textContent = data.error;
                }
            } catch (err) {
                document.getElementById('loginError').textContent = 'Login failed';
            }
        }

        async function register() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const fullName = document.getElementById('registerFullName').value;
            const schoolName = document.getElementById('registerSchoolName').value;
            const className = document.getElementById('registerClass').value;
            const email = document.getElementById('registerEmail').value;
            const phoneNumber = document.getElementById('registerPhoneNumber').value;

            if (!username || !password || !fullName || !schoolName || !className) {
                document.getElementById('registerError').textContent = 'Please fill all required fields';
                return;
            }
            
            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, fullName, schoolName, class: className, email, phoneNumber })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    document.getElementById('registerError').textContent = '';
                    alert('Registration successful! Please login.');
                    closeModal('registerModal');
                    // Clear form
                    document.getElementById('registerUsername').value = '';
                    document.getElementById('registerPassword').value = '';
                    document.getElementById('registerFullName').value = '';
                    document.getElementById('registerSchoolName').value = '';
                    document.getElementById('registerClass').value = '';
                    document.getElementById('registerEmail').value = '';
                    document.getElementById('registerPhoneNumber').value = '';
                    showLogin();
                } else {
                    document.getElementById('registerError').textContent = data.error;
                }
            } catch (err) {
                document.getElementById('registerError').textContent = 'Registration failed';
            }
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                isAuthenticated = false;
                isAdmin = false;
                document.getElementById('authSection').style.display = 'flex';
                document.getElementById('userSection').style.display = 'none';
                document.getElementById('profileDetails').style.display = 'none';
                showHomePage();
                loadGames();
            } catch (err) {
                console.error('Logout failed:', err);
            }
        }

        async function createGame() {
            const title = document.getElementById('gameTitle').value;
            const htmlContent = document.getElementById('gameHtml').value;
            
            if (!title || !htmlContent) {
                document.getElementById('createError').textContent = 'Please fill all fields';
                return;
            }
            
            try {
                const res = await fetch('/api/games', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, htmlContent })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    closeModal('createGameModal');
                    document.getElementById('gameTitle').value = '';
                    document.getElementById('gameHtml').value = '';
                    loadGames();
                    alert('Game created successfully!');
                } else {
                    document.getElementById('createError').textContent = data.error;
                }
            } catch (err) {
                document.getElementById('createError').textContent = 'Failed to create game';
            }
        }

        async function loadGames() {
            try {
                const res = await fetch('/api/games');
                const games = await res.json();
                
                const grid = document.getElementById('gamesGrid');
                
                if (games.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <h2>No games yet!</h2>
                            <p>Be the first to create an HTML game</p>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = games.map(game => `
                    <div class="game-tile">
                        <div class="game-title" onclick="showGameDetail('${game.id}')">${escapeHtml(game.title)}</div>
                        <div class="game-author">by ${escapeHtml(game.author)}</div>
                        <div class="game-stats">
                            <div class="stat ${game.userLiked ? 'active' : ''}">👍 ${game.likesCount}</div>
                            <div class="stat ${game.userDisliked ? 'active' : ''}">👎 ${game.dislikesCount}</div>
                            <div class="stat">💬 ${game.commentsCount}</div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load games:', err);
                document.getElementById('gamesGrid').innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <h2>Error loading games</h2>
                        <p>Please try refreshing the page</p>
                    </div>
                `;
            }
        }

        async function showGameDetail(gameId) {
            currentGameId = gameId;
            
            try {
                const res = await fetch(`/api/games/${gameId}`);
                
                if (!res.ok) {
                    throw new Error('Game not found');
                }
                
                const game = await res.json();
                
                document.getElementById('gameDetailTitle').textContent = game.title;
                document.getElementById('gameDetailAuthor').textContent = `by ${game.author}`;
                document.getElementById('gameDetailAuthorInfo').textContent = `From ${game.authorSchool}, Class ${game.authorClass}`;
                document.getElementById('likeCount').textContent = game.likesCount;
                document.getElementById('dislikeCount').textContent = game.dislikesCount;
                
                const likeBtn = document.getElementById('likeBtn');
                const dislikeBtn = document.getElementById('dislikeBtn');
                
                // Remove active class from both first
                likeBtn.classList.remove('active');
                dislikeBtn.classList.remove('active');
                
                // Add active class if user liked/disliked
                if (game.userLiked) {
                    likeBtn.classList.add('active');
                }
                if (game.userDisliked) {
                    dislikeBtn.classList.add('active');
                }
                
                loadComments(gameId);
                
                document.getElementById('gameDetailModal').classList.add('active');
            } catch (err) {
                console.error('Failed to load game:', err);
                alert('Failed to load game details: ' + err.message);
            }
        }

        async function playGame() {
            // Open game in new window
            window.open(`/play/${currentGameId}`, '_blank');
        }

        async function likeGame() {
            if (!isAuthenticated) {
                alert('Please login first');
                return;
            }
            
            try {
                const res = await fetch(`/api/games/${currentGameId}/like`, { method: 'POST' });
                const data = await res.json();
                
                document.getElementById('likeCount').textContent = data.likesCount;
                document.getElementById('dislikeCount').textContent = data.dislikesCount;
                
                document.getElementById('likeBtn').classList.toggle('active', data.userLiked);
                document.getElementById('dislikeBtn').classList.toggle('active', data.userDisliked);
                
                loadGames();
            } catch (err) {
                console.error('Failed to like game:', err);
            }
        }

        async function dislikeGame() {
            if (!isAuthenticated) {
                alert('Please login first');
                return;
            }
            
            try {
                const res = await fetch(`/api/games/${currentGameId}/dislike`, { method: 'POST' });
                const data = await res.json();
                
                document.getElementById('likeCount').textContent = data.likesCount;
                document.getElementById('dislikeCount').textContent = data.dislikesCount;
                
                document.getElementById('likeBtn').classList.toggle('active', data.userLiked);
                document.getElementById('dislikeBtn').classList.toggle('active', data.userDisliked);
                
                loadGames();
            } catch (err) {
                console.error('Failed to dislike game:', err);
            }
        }

        async function loadComments(gameId) {
            try {
                const res = await fetch(`/api/games/${gameId}/comments`);
                const comments = await res.json();
                
                document.getElementById('commentCountDetail').textContent = comments.length;
                
                const commentsList = document.getElementById('commentsList');
                commentsList.innerHTML = comments.map(comment => `
                    <div class="comment">
                        <div class="comment-author">${escapeHtml(comment.author)}</div>
                        <div class="comment-text">${escapeHtml(comment.text)}</div>
                    </div>
                `).join('') || '<p style="color: #999;">No comments yet</p>';
            } catch (err) {
                console.error('Failed to load comments:', err);
            }
        }

        async function addComment() {
            if (!isAuthenticated) {
                alert('Please login first');
                return;
            }
            
            const text = document.getElementById('commentText').value.trim();
            if (!text) {
                alert('Please enter a comment');
                return;
            }
            
            try {
                const res = await fetch(`/api/games/${currentGameId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                
                if (res.ok) {
                    document.getElementById('commentText').value = '';
                    loadComments(currentGameId);
                    loadGames();
                } else {
                    alert('Failed to add comment');
                }
            } catch (err) {
                console.error('Failed to add comment:', err);
                alert('Failed to add comment');
            }
        }

        function showHomePage() {
            document.getElementById('profilePage').style.display = 'none';
            document.getElementById('gamesGrid').style.display = 'grid';
            loadGames();
        }

        async function showProfilePage() {
            document.getElementById('gamesGrid').style.display = 'none';
            document.getElementById('profilePage').style.display = 'block';

            const profileTitle = document.getElementById('profileTitle');
            const profileGrid = document.getElementById('profileGamesGrid');
            profileTitle.textContent = isAdmin ? 'All Games (Admin View)' : 'My Profile';

            // Fetch and display profile details
            if (!isAdmin) {
                try {
                    const res = await fetch('/api/user/profile');
                    if (res.ok) {
                        const profile = await res.json();
                        document.getElementById('profileDetails').style.display = 'block';
                        document.getElementById('profileFullName').textContent = profile.fullName;
                        document.getElementById('profileSchoolName').textContent = profile.schoolName;
                        document.getElementById('profileClass').textContent = profile.class;
                        document.getElementById('profileEmail').textContent = profile.email || 'N/A';
                        document.getElementById('profilePhoneNumber').textContent = profile.phoneNumber || 'N/A';
                    } else {
                         document.getElementById('profileDetails').style.display = 'none';
                    }
                } catch (err) {
                    console.error('Failed to load profile details:', err);
                    document.getElementById('profileDetails').style.display = 'none';
                }
            } else {
                document.getElementById('profileDetails').style.display = 'none';
            }

            try {
                const res = await fetch('/api/my-games');
                const games = await res.json();

                if (games.length === 0) {
                    profileGrid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><h2>No games found.</h2></div>`;
                    return;
                }

                profileGrid.innerHTML = games.map(game => `
                    <div class="game-tile">
                        <div class="game-title" onclick="showGameDetail('${game.id}')">${escapeHtml(game.title)}</div>
                        <div class="game-author">by ${escapeHtml(game.author)}</div>
                        <div class="game-stats">
                            <div class="stat">👍 ${game.likesCount}</div>
                            <div class="stat">👎 ${game.dislikesCount}</div>
                            <div class="stat">💬 ${game.commentsCount}</div>
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="showUpdateGame('${game.id}')">Update</button>
                            <button class="btn btn-primary" style="background: #ef4444;" onclick="deleteGame('${game.id}')">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load profile games:', err);
                profileGrid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><h2>Error loading games.</h2></div>`;
            }
        }

        async function showEditProfile() {
            try {
                const res = await fetch('/api/user/profile');
                if (res.ok) {
                    const profile = await res.json();
                    document.getElementById('editFullName').value = profile.fullName;
                    document.getElementById('editSchoolName').value = profile.schoolName;
                    document.getElementById('editClass').value = profile.class;
                    document.getElementById('editEmail').value = profile.email;
                    document.getElementById('editPhoneNumber').value = profile.phoneNumber;
                    document.getElementById('editProfileModal').classList.add('active');
                } else {
                    alert('Could not load profile data.');
                }
            } catch (err) {
                alert('An error occurred while fetching profile data.');
            }
        }

        async function updateProfile() {
            const fullName = document.getElementById('editFullName').value;
            const schoolName = document.getElementById('editSchoolName').value;
            const className = document.getElementById('editClass').value;
            const email = document.getElementById('editEmail').value;
            const phoneNumber = document.getElementById('editPhoneNumber').value;

            if (!fullName || !schoolName || !className) {
                document.getElementById('editProfileError').textContent = 'Full name, school name, and class are required.';
                return;
            }

            try {
                const res = await fetch('/api/user/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fullName, schoolName, class: className, email, phoneNumber })
                });

                if (res.ok) {
                    closeModal('editProfileModal');
                    showProfilePage(); // Refresh profile page to show new data
                    alert('Profile updated successfully!');
                } else {
                    const data = await res.json();
                    document.getElementById('editProfileError').textContent = data.error || 'Failed to update profile.';
                }
            } catch (err) {
                document.getElementById('editProfileError').textContent = 'An error occurred.';
            }
        }

        async function showUpdateGame(gameId) {
            try {
                const res = await fetch(`/api/games/${gameId}`);
                if (!res.ok) {
                    throw new Error('Game not found');
                }
                const game = await res.json();

                document.getElementById('updateGameId').value = game.id;
                document.getElementById('updateGameTitle').value = game.title;
                document.getElementById('updateGameHtml').value = game.htmlContent;

                document.getElementById('updateGameModal').classList.add('active');
            } catch (err) {
                alert('Failed to load game data for updating: ' + err.message);
            }
        }

        async function updateGame() {
            const gameId = document.getElementById('updateGameId').value;
            const title = document.getElementById('updateGameTitle').value;
            const htmlContent = document.getElementById('updateGameHtml').value;

            if (!title || !htmlContent) {
                document.getElementById('updateError').textContent = 'Please fill all fields';
                return;
            }

            try {
                const res = await fetch(`/api/games/${gameId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, htmlContent })
                });

                const data = await res.json();

                if (res.ok) {
                    closeModal('updateGameModal');
                    showProfilePage(); // Refresh the profile page
                    alert('Game updated successfully!');
                } else {
                    document.getElementById('updateError').textContent = data.error;
                }
            } catch (err) {
                document.getElementById('updateError').textContent = 'Failed to update game';
            }
        }

        async function deleteGame(gameId) {
            if (!confirm('Are you sure you want to delete this game? This action cannot be undone.')) {
                return;
            }

            try {
                const res = await fetch(`/api/games/${gameId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    alert('Game deleted successfully.');
                    showProfilePage(); // Refresh profile view
                } else {
                    const data = await res.json();
                    alert('Failed to delete game: ' + data.error);
                }
            } catch (err) {
                console.error('Delete game error:', err);
                alert('An error occurred while deleting the game.');
            }
        }

        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Allow Enter key to submit forms
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                if (document.getElementById('loginModal').classList.contains('active')) {
                    login();
                } else if (document.getElementById('registerModal').classList.contains('active')) {
                    register();
                }
            }
        });

        // Initialize
        checkSession();
    </script>
</body>
</html>